<div class="row g-3">
  <% @status_counts.each do |status, count| %>
    <div class="col-6 col-md-3">
      <%= link_to agenda_items_path(filters: { status: status }), class: 'text-decoration-none text-reset d-block' do %>
        <div class="dashboard-stat-card h-100">
          <div class="stat-icon">
            <% case status %>
            <% when 'backlog' %>
              <i class="bi bi-list-ul"></i>
            <% when 'scoped' %>
              <i class="bi bi-file-text"></i>
            <% when 'in_progress' %>
              <i class="bi bi-arrow-repeat"></i>
            <% when 'blocked' %>
              <i class="bi bi-exclamation-triangle"></i>
            <% when 'in_review' %>
              <i class="bi bi-eye"></i>
            <% when 'completed' %>
              <i class="bi bi-check-circle"></i>
            <% when 'archived' %>
              <i class="bi bi-archive"></i>
            <% when 'cancelled' %>
              <i class="bi bi-x-circle"></i>
            <% else %>
              <i class="bi bi-circle"></i>
            <% end %>
          </div>
          <div class="stat-content">
            <div class="stat-label"><%= status.titleize %></div>
            <div class="stat-value"><%= count %></div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div class="row g-4 mt-2">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white section-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Priority queue</h5>
          <%= link_to 'View agenda', agenda_items_path, class: 'btn btn-outline-dark btn-sm' %>
        </div>
      </div>
      <div class="card-body">
        <% if @top_agenda_items.any? %>
          <% @top_agenda_items.each do |item| %>
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between py-3 border-bottom priority-queue-item">
              <div>
                <h6 class="mb-1"><%= link_to item.title, agenda_item_path(item), class: 'link-body-emphasis text-decoration-none' %></h6>
                <div class="text-muted small">
                  <%= item.client.name %> - Due <%= item.due_on ? item.due_on.strftime('%b %d') : 'TBD' %>
                </div>
                <div class="mt-1 d-flex flex-wrap gap-2">
                  <span class="badge bg-<%= item.status_badge_color %>"><%= item.status.titleize %></span>
                  <span class="badge bg-<%= item.priority_badge_color %>">Priority: <%= item.priority_level.titleize %></span>
                  <span class="badge bg-outline">Complexity: <%= item.complexity %>/5</span>
                </div>
              </div>
              <div class="text-end mt-2 mt-lg-0">
                <div class="small text-muted">Rank</div>
                <div class="h4 mb-0 rank-score"><%= item.rank_score %></div>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No active agenda items yet.</p>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white section-header">
        <h6 class="mb-0 text-danger">Overdue</h6>
      </div>
      <div class="card-body" style="overflow-y: auto; max-height: 200px; overflow-x: hidden;">
        <% if @overdue_agenda_items.any? %>
          <% @overdue_agenda_items.each do |item| %>
            <div class="mb-3">
              <div class="fw-semibold"><%= link_to item.title, agenda_item_path(item), class: 'link-danger text-decoration-none' %></div>
              <div class="small text-muted">Due <%= item.due_on&.strftime('%b %d') %> - <%= item.client.name %></div>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted small mb-0">Great job! Nothing overdue.</p>
        <% end %>
      </div>
    </div>
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h6 class="mb-0 upcoming-header">Upcoming (14 days)</h6>
      </div>
      <div class="card-body" style="overflow-y: auto; max-height: 200px; overflow-x: hidden;">
        <% if @upcoming_agenda_items.any? %>
          <% @upcoming_agenda_items.each do |item| %>
            <div class="mb-3">
              <div class="fw-semibold"><%= link_to item.title, agenda_item_path(item), class: 'text-decoration-none upcoming-link' %></div>
              <div class="small text-muted">Due <%= item.due_on&.strftime('%b %d') %> - <%= item.client.name %></div>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted small mb-0">No upcoming deadlines.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mt-4">
  <div class="card-header bg-white border-0">
    <h5 class="mb-0 client-health-heading">Client health</h5>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <% @client_snapshots.each do |snapshot| %>
        <div class="col-md-6 col-lg-4">
          <div class="client-health-card border rounded-3 p-3 h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h6 class="mb-0"><%= link_to snapshot[:client].name, client_path(snapshot[:client]), class: 'text-decoration-none client-name-link' %></h6>
                <div class="text-muted small"><%= snapshot[:client].priority_level.titleize %> client</div>
              </div>
              <span class="badge client-code-badge"><%= snapshot[:client].status.titleize %></span>
            </div>
            <div class="d-flex flex-wrap gap-3">
              <div>
                <div class="text-muted small">Open</div>
                <div class="h5 mb-0"><%= snapshot[:open_items] %></div>
              </div>
              <div>
                <div class="text-muted small">Urgent</div>
                <div class="h5 mb-0 text-danger"><%= snapshot[:urgent_items] %></div>
              </div>
              <div>
                <div class="text-muted small">Overdue</div>
                <div class="h5 mb-0 text-warning"><%= snapshot[:overdue_items] %></div>
              </div>
              <div>
                <div class="text-muted small">Velocity (14d)</div>
                <div class="h5 mb-0 text-success"><%= snapshot[:velocity] %></div>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
