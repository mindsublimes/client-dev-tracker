<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-0">Activity Reports</h1>
    <p class="text-muted mb-0">Daily work summary and activity analytics</p>
  </div>
  <%= form_with url: reports_path, method: :get, local: true, class: 'd-flex gap-2 align-items-end' do |form| %>
    <div>
      <%= form.label :start_date, 'From', class: 'form-label small mb-1' %>
      <%= form.date_field :start_date, value: @start_date, class: 'form-control form-control-sm' %>
    </div>
    <div>
      <%= form.label :end_date, 'To', class: 'form-label small mb-1' %>
      <%= form.date_field :end_date, value: @end_date, class: 'form-control form-control-sm' %>
    </div>
    <%= form.submit 'Update', class: 'btn btn-sm btn-outline-primary mb-2' %>
  <% end %>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small mb-1">Total Activities</div>
            <div class="h4 mb-0"><%= @total_activities %></div>
          </div>
          <i class="bi bi-activity text-primary" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small mb-1">Agenda Items</div>
            <div class="h4 mb-0"><%= @total_agenda_items %></div>
          </div>
          <i class="bi bi-list-check text-info" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small mb-1">Status Changes</div>
            <div class="h4 mb-0"><%= @status_changes %></div>
          </div>
          <i class="bi bi-arrow-repeat text-warning" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-muted small mb-1">Items Completed</div>
            <div class="h4 mb-0"><%= @items_completed %></div>
          </div>
          <i class="bi bi-check-circle text-success" style="font-size: 2rem; opacity: 0.3;"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Daily Activity Chart -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h5 class="mb-0">Daily Activity Overview</h5>
      </div>
      <div class="card-body">
        <canvas id="dailyActivityChart" height="100"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Activity by Type -->
  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h5 class="mb-0">Activity by Type</h5>
      </div>
      <div class="card-body">
        <canvas id="activityTypeChart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-2">
  <!-- Activity by User -->
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h5 class="mb-0">Activity by User</h5>
      </div>
      <div class="card-body">
        <canvas id="activityByUserChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Daily Breakdown Table -->
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h5 class="mb-0">Daily Breakdown</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm">
            <thead class="sticky-top bg-white">
              <tr>
                <th>Date</th>
                <th class="text-end">Total</th>
                <th class="text-end">Status</th>
                <th class="text-end">Messages</th>
                <th class="text-end">Completed</th>
                <th class="text-end">Created</th>
              </tr>
            </thead>
            <tbody>
              <% @daily_breakdown.sort.reverse.each do |date, data| %>
                <tr>
                  <td><%= date.strftime('%b %d, %Y') %></td>
                  <td class="text-end"><%= data[:total] %></td>
                  <td class="text-end"><%= data[:status_changes] %></td>
                  <td class="text-end"><%= data[:messages] %></td>
                  <td class="text-end"><%= data[:completions] %></td>
                  <td class="text-end"><%= data[:creations] %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Daily Activity Chart
  const dailyCtx = document.getElementById('dailyActivityChart');
  if (dailyCtx) {
    const dailyData = <%= @daily_breakdown.map { |date, data| [date.strftime('%b %d'), data[:total]] }.to_h.to_json.html_safe %>;
    new Chart(dailyCtx, {
      type: 'line',
      data: {
        labels: Object.keys(dailyData),
        datasets: [{
          label: 'Total Activities',
          data: Object.values(dailyData),
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // Activity by Type Chart
  const typeCtx = document.getElementById('activityTypeChart');
  if (typeCtx) {
    const typeData = <%= @activity_by_type.to_json.html_safe %>;
    const formatLabel = (str) => {
      return str.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    };
    new Chart(typeCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(typeData).map(formatLabel),
        datasets: [{
          data: Object.values(typeData),
          backgroundColor: [
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(239, 68, 68, 0.8)',
            'rgba(139, 92, 246, 0.8)',
            'rgba(236, 72, 153, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // Activity by User Chart
  const userCtx = document.getElementById('activityByUserChart');
  if (userCtx) {
    const userData = <%= @activity_by_user.to_json.html_safe %>;
    new Chart(userCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(userData),
        datasets: [{
          label: 'Activities',
          data: Object.values(userData),
          backgroundColor: 'rgba(59, 130, 246, 0.8)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }
});
</script>
