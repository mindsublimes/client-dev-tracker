<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <p class="text-muted mb-1"><%= @agenda_item.client.name %> - <%= @agenda_item.work_stream.titleize %></p>
    <h1 class="h3 mb-2"><%= @agenda_item.title %></h1>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-<%= @agenda_item.status_badge_color %>"><%= @agenda_item.status.titleize %></span>
      <span class="badge bg-<%= @agenda_item.priority_badge_color %>">Priority <%= @agenda_item.priority_level.titleize %></span>
      <span class="badge bg-secondary">Complexity <%= @agenda_item.complexity_label %></span>
      <span class="badge client-code-badge">Rank <%= @agenda_item.rank_score %></span>
    </div>
  </div>
  <% if policy(@agenda_item).update? %>
    <div class="d-flex flex-wrap gap-2">
      <%= link_to 'Edit', edit_agenda_item_path(@agenda_item), class: 'btn btn-outline-dark' %>
      <% if policy(@agenda_item).complete? %>
        <% if @agenda_item.completed? %>
          <%= button_to 'Reopen', reopen_agenda_item_path(@agenda_item), method: :patch, class: 'btn btn-new-agenda' %>
        <% else %>
          <%= button_to 'Mark complete', complete_agenda_item_path(@agenda_item), method: :patch, class: 'btn btn-new-agenda' %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white section-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Delivery details</h5>
      </div>
      <div class="card-body">
        <p class="text-body-secondary"><%= simple_format(@agenda_item.description.presence || 'No description provided.') %></p>
        <div class="row g-3 mt-3">
          <div class="col-md-6">
            <div class="text-muted small">Due date</div>
            <div class="fw-semibold"><%= @agenda_item.due_on&.strftime('%B %d, %Y') || 'TBD' %></div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Assignee</div>
            <div class="fw-semibold"><%= @agenda_item.assignee&.full_name || 'Not assigned' %></div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Project</div>
            <div class="fw-semibold">
              <% if @agenda_item.project && policy(@agenda_item.project).show? %>
                <%= link_to @agenda_item.project.name, project_path(@agenda_item.project), class: 'text-decoration-none' %>
              <% else %>
                <%= @agenda_item.project&.name || 'Not linked' %>
              <% end %>
            </div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Sprint</div>
            <div class="fw-semibold">
              <% if @agenda_item.sprint && policy(@agenda_item.sprint).show? %>
                <%= link_to @agenda_item.sprint.name, sprint_path(@agenda_item.sprint), class: 'text-decoration-none' %>
              <% else %>
                <%= @agenda_item.sprint&.name || 'Not assigned' %>
              <% end %>
            </div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Requested by</div>
            <div class="fw-semibold"><%= @agenda_item.requested_by.presence || 'Not captured' %></div>
            <% if @agenda_item.requested_by_email.present? %>
              <div class="small text-muted"><%= @agenda_item.requested_by_email %></div>
            <% end %>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Cost</div>
            <% if @agenda_item.estimated_cost.present? %>
              <div class="fw-semibold">$<%= number_with_precision(@agenda_item.estimated_cost, precision: 2) %> <span class="badge bg-<%= @agenda_item.paid? ? 'success' : 'warning' %> ms-2"><%= @agenda_item.paid? ? 'Paid' : 'Unpaid' %></span></div>
            <% else %>
              <div class="fw-semibold">Not estimated</div>
            <% end %>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Notes</div>
            <div><%= simple_format(@agenda_item.notes.presence || 'No internal notes yet.') %></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h5 class="mb-0">Conversation</h5>
      </div>
      <div class="card-body conversation-scrollable">
        <% if @messages.any? %>
          <div class="timeline">
            <% @messages.each do |message| %>
              <div class="timeline-entry">
                <div class="timeline-dot bg-dark"></div>
                <div class="timeline-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong><%= message.user.full_name %></strong>
                      <span class="badge client-code-badge ms-2"><%= message.kind.titleize %></span>
                    </div>
                    <small class="text-muted"><%= l message.created_at, format: :short %></small>
                  </div>
                  <p class="mb-2"><%= simple_format(message.body) %></p>
                  <% if message.files.attached? %>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                      <% message.files.each do |file| %>
                        <% if file.image? %>
                          <% thumbnail_url = attachment_thumbnail_url(file) %>
                          <% next unless thumbnail_url %>
                          <div class="attachment-card">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-full-image-url="<%= url_for(file) %>">
                              <%= image_tag thumbnail_url, class: 'img-thumbnail', alt: file.filename.to_s, style: 'max-width: 150px; max-height: 150px; object-fit: cover;' %>
                            </a>
                            <div class="file-name"><%= file.filename.to_s %></div>
                          </div>
                        <% else %>
                          <%= link_to file.filename.to_s, url_for(file), class: 'btn btn-sm btn-outline-secondary' %>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">No updates yet. Start the conversation below.</p>
        <% end %>
      </div>
      <div class="card-footer bg-white border-0 border-top">
        <%= render 'agenda_messages/form', agenda_item: @agenda_item, message: @message %>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white section-header">
        <h6 class="mb-0">Rank breakdown</h6>
      </div>
      <div class="card-body">
        <% breakdown = (@agenda_item.rank_breakdown || {}).transform_keys(&:to_s) %>
        <% display_keys = %w[priority due_date complexity status inactivity] %>

        <% if breakdown.present? %>
          <% display_keys.each do |key| %>
            <% next unless breakdown.key?(key) %>
            <div class="rank-breakdown-row d-flex justify-content-between py-2 border-bottom">
              <span class="text-muted"><%= key.tr('_', ' ').titleize %></span>
              <span class="fw-semibold"><%= breakdown[key] %></span>
            </div>
          <% end %>

          <% raw_score = breakdown['raw_score'] || @agenda_item.rank_score %>
          <div class="rank-breakdown-row rank-total d-flex justify-content-between py-2">
            <span>Rank</span>
            <span><%= raw_score %></span>
          </div>
        <% else %>
          <p class="text-muted mb-0">Rank has not been calculated yet.</p>
        <% end %>
      </div>
    </div>

    <div class="card shadow-sm border-0 mt-3">
      <div class="card-header bg-white section-header">
        <h6 class="mb-0">Activity</h6>
      </div>
      <div class="card-body" style="max-height: 260px; overflow-y: auto; overflow-x: hidden;">
        <% if @activity_logs.any? %>
          <% @activity_logs.each do |log| %>
            <div class="activity-log-entry mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between small text-muted">
                <span><%= log.created_at.strftime('%I:%M %p') %></span>
                <span><%= log.actor_name %></span>
              </div>
              <div class="fw-semibold"><%= log.display_message %></div>
              <% if log.field_name == 'message' && log.new_value.present? %>
                <div class="text-muted small"><%= log.new_value %></div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">No activity logged yet.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Full Size Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="fullSizeImage" class="img-fluid" alt="Full Size Image">
      </div>
    </div>
  </div>
</div>
